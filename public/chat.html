<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acaragraph Red - –ß–∞—Ç</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
</head>
<body>
    <div class="chat-container">
        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="sidebar">
            <!-- –•–µ–¥–µ—Ä –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ -->
            <div class="sidebar-header">
                <div class="user-profile">
                    <div class="user-avatar" id="currentUserAvatar">
                        A
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="currentUserName">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                        <div class="user-status">
                            <span class="status-dot online" id="statusDot"></span>
                            <span id="currentUserRole">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —á–∞—Ç–∞ -->
            <div class="card" style="margin: 15px; padding: 15px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                    <div>
                        <div style="font-size: 12px; color: #FF6666;">–û–ù–õ–ê–ô–ù</div>
                        <div style="font-size: 24px; font-weight: bold;" id="onlineCount">0</div>
                    </div>
                    <div>
                        <div style="font-size: 12px; color: #FF6666;">–°–û–û–ë–©–ï–ù–ò–Ø</div>
                        <div style="font-size: 24px; font-weight: bold;" id="messageCount">0</div>
                    </div>
                </div>
                <div style="text-align: center;">
                    <button class="btn btn-primary btn-sm w-100" onclick="testConnection()">
                        <i class="fas fa-wifi"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å
                    </button>
                </div>
            </div>

            <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
            <div class="card" style="margin: 0 15px 15px; padding: 15px;">
                <div class="card-header" style="padding: 0; margin-bottom: 15px; border: none;">
                    <h3 style="font-size: 16px;"><i class="fas fa-users"></i> –û–ù–õ–ê–ô–ù</h3>
                    <div style="font-size: 12px; color: #FF6666;" id="onlineUsersCount">0</div>
                </div>
                <div class="users-list" id="usersList">
                    <!-- –°–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∑–¥–µ—Å—å -->
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π...</div>
                    </div>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è -->
            <div class="sidebar-footer" style="padding: 15px; margin-top: auto;">
                <div style="display: flex; gap: 10px;">
                    <button class="btn btn-secondary btn-sm flex-1" onclick="window.location.href='admin.html'" id="adminBtn" style="display: none;">
                        <i class="fas fa-crown"></i> –ê–¥–º–∏–Ω–∫–∞
                    </button>
                    <button class="btn btn-secondary btn-sm" onclick="showSettings()">
                        <i class="fas fa-cog"></i>
                    </button>
                    <button class="btn btn-danger btn-sm" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å —á–∞—Ç–∞ -->
        <div class="chat-main">
            <!-- –•–µ–¥–µ—Ä —á–∞—Ç–∞ -->
            <div class="chat-header">
                <div class="chat-title">
                    <div class="chat-icon">
                        <i class="fas fa-comments"></i>
                    </div>
                    <div>
                        <h2 style="color: #FFFFFF;">–û–ë–©–ò–ô –ß–ê–¢</h2>
                        <div style="font-size: 14px; color: #FF6666;">
                            <span id="typingIndicator"></span>
                        </div>
                    </div>
                </div>
                <div class="chat-info">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <div id="connectionStatus" style="display: flex; align-items: center; gap: 5px;">
                            <div class="status-dot" id="connectionDot" style="background: #00CC00;"></div>
                            <span style="color: #AAAAAA;">–ü–æ–¥–∫–ª—é—á–µ–Ω</span>
                        </div>
                        <button class="btn btn-secondary btn-sm" onclick="clearChat()">
                            <i class="fas fa-trash"></i> –û—á–∏—Å—Ç–∏—Ç—å
                        </button>
                    </div>
                </div>
            </div>

            <!-- –û–∫–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="chat-messages" id="chatMessages">
                <!-- –°–æ–æ–±—â–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–¥–µ—Å—å -->
                <div class="loading">
                    <div class="loading-spinner"></div>
                    <div class="loading-text">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π...</div>
                </div>
            </div>

            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="chat-input-container">
                <div class="message-input-wrapper">
                    <textarea 
                        id="messageInput" 
                        class="message-input" 
                        placeholder="–ù–∞–ø–∏—à–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                        rows="1"
                        maxlength="2000"
                        oninput="autoResize(this); checkTyping()"
                        onkeydown="handleKeyDown(event)"
                    ></textarea>
                    <button class="send-button" onclick="sendMessage()" id="sendButton">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                    <div style="font-size: 12px; color: #888888;">
                        <span id="charCount">0/2000</span>
                        <span style="margin-left: 10px;">Enter - –æ—Ç–ø—Ä–∞–≤–∏—Ç—å, Shift+Enter - –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞</span>
                    </div>
                    <div>
                        <button class="btn btn-secondary btn-sm" onclick="insertEmoji('üòÄ')" title="–°–º–∞–π–ª–∏–∫">
                            <i class="far fa-smile"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="attachFile()" title="–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª">
                            <i class="fas fa-paperclip"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #FF0000;">
                    <i class="fas fa-user"></i>
                    <span id="profileUserName">–ü—Ä–æ—Ñ–∏–ª—å</span>
                </h3>
                <button class="modal-close" onclick="closeProfile()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div class="user-avatar" id="profileUserAvatar" style="width: 100px; height: 100px; font-size: 40px; margin: 0 auto 15px;">
                        A
                    </div>
                    <div style="margin-bottom: 10px;">
                        <span class="status-badge" id="profileUserRole">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</span>
                        <span class="status-badge" id="profileUserStatus">–û–Ω–ª–∞–π–Ω</span>
                    </div>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <div style="font-size: 12px; color: #FF6666; margin-bottom: 5px;">–ò–º—è:</div>
                            <div style="color: #FFFFFF; font-weight: bold;" id="profileNickname">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #FF6666; margin-bottom: 5px;">Telegram:</div>
                            <div style="color: #FFFFFF;" id="profileTelegram">-</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #FF6666; margin-bottom: 5px;">–°–æ–æ–±—â–µ–Ω–∏–π:</div>
                            <div style="color: #FFFFFF;" id="profileMessageCount">0</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #FF6666; margin-bottom: 5px;">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</div>
                            <div style="color: #FFFFFF;" id="profileRegistered">-</div>
                        </div>
                    </div>
                </div>
                
                <div id="adminActions" style="display: none; margin-top: 20px; border-top: 1px solid rgba(255, 0, 0, 0.2); padding-top: 20px;">
                    <h4 style="color: #FF6666; margin-bottom: 15px;">
                        <i class="fas fa-user-shield"></i> –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                    </h4>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <button class="btn btn-danger btn-sm" onclick="adminAction('ban')">
                            <i class="fas fa-ban"></i> –ó–∞–±–∞–Ω–∏—Ç—å
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="adminAction('mute')">
                            <i class="fas fa-volume-mute"></i> –ú—É—Ç 5 –º–∏–Ω
                        </button>
                        <button class="btn btn-success btn-sm" onclick="adminAction('make_admin')">
                            <i class="fas fa-crown"></i> –°–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="adminAction('remove_admin')">
                            <i class="fas fa-user"></i> –£–±—Ä–∞—Ç—å –∞–¥–º–∏–Ω–∞
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–∫ -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #FF0000;">
                    <i class="fas fa-cog"></i> –ù–∞—Å—Ç—Ä–æ–π–∫–∏
                </h3>
                <button class="modal-close" onclick="closeSettings()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</label>
                    <label class="checkbox">
                        <input type="checkbox" id="notifyNewMessages" checked>
                        <span class="checkmark"></span>
                        –ù–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" id="notifyUserJoin" checked>
                        <span class="checkmark"></span>
                        –í—Ö–æ–¥/–≤—ã—Ö–æ–¥ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–í–Ω–µ—à–Ω–∏–π –≤–∏–¥</label>
                    <label class="checkbox">
                        <input type="checkbox" id="darkMode" checked disabled>
                        <span class="checkmark"></span>
                        –¢–µ–º–Ω–∞—è —Ç–µ–º–∞ (Acaragraph Red)
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">–ü–æ–≤–µ–¥–µ–Ω–∏–µ</label>
                    <label class="checkbox">
                        <input type="checkbox" id="enterToSend" checked>
                        <span class="checkmark"></span>
                        Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
                    </label>
                    <label class="checkbox">
                        <input type="checkbox" id="soundEffects" checked>
                        <span class="checkmark"></span>
                        –ó–≤—É–∫–æ–≤—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã
                    </label>
                </div>
                
                <div style="border-top: 1px solid rgba(255, 0, 0, 0.2); padding-top: 20px; margin-top: 20px;">
                    <h4 style="color: #FF6666; margin-bottom: 15px;">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–µ—Å—Å–∏–∏</h4>
                    <div style="font-size: 12px; color: #888888;">
                        <div>ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: <span id="sessionUserId">-</span></div>
                        <div>–í—Ä–µ–º—è –≤—Ö–æ–¥–∞: <span id="sessionLoginTime">-</span></div>
                        <div>–í–µ—Ä—Å–∏—è: Acaragraph Red 1.0.0</div>
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                </button>
                <button class="btn btn-secondary" onclick="closeSettings()">
                    <i class="fas fa-times"></i> –û—Ç–º–µ–Ω–∞
                </button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notificationContainer"></div>

    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Socket.io -->
    <script src="/socket.io/socket.io.js"></script>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç —á–∞—Ç–∞ -->
    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let socket = null;
        let currentUser = null;
        let onlineUsers = [];
        let messages = [];
        let selectedUserId = null;
        let typingTimeout = null;
        let isTyping = false;
        let reconnectAttempts = 0;
        const MAX_RECONNECT_ATTEMPTS = 10;

        // ========== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ==========
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üöÄ Acaragraph Red - —á–∞—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            await loadUserData();
            
            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º WebSocket —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            initSocket();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            loadMessages();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            loadOnlineUsers();
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
            loadSettings();
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                document.getElementById('messageInput')?.focus();
            }, 1000);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
            setInterval(updateUserStatus, 30000);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
            setInterval(checkConnection, 10000);
        });

        // ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–¨ ==========
        async function loadUserData() {
            try {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
                const savedUser = localStorage.getItem('acaragraph_user');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∏–∑ localStorage:', currentUser);
                } else {
                    // –ï—Å–ª–∏ –Ω–µ—Ç –≤ localStorage, –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å —Å–µ—Ä–≤–µ—Ä–∞
                    const response = await fetch('/api/auth/me');
                    const data = await response.json();
                    
                    if (data.success) {
                        currentUser = data.user;
                        localStorage.setItem('acaragraph_user', JSON.stringify(currentUser));
                        console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Å–µ—Ä–≤–µ—Ä–∞:', currentUser);
                    } else {
                        // –ï—Å–ª–∏ –Ω–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —Ä–µ–¥–∏—Ä–µ–∫—Ç –Ω–∞ –≤—Ö–æ–¥
                        window.location.href = 'index.html';
                        return;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                updateUserDisplay();
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –∞–¥–º–∏–Ω–∫–∏ –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω
                if (currentUser.role === 'admin' || currentUser.role === 'super_admin') {
                    document.getElementById('adminBtn').style.display = 'block';
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', error);
                showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                
                // –ü—Ä–æ–±—É–µ–º –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                if (!currentUser) {
                    currentUser = {
                        id: 1,
                        nickname: '–¢–µ—Å—Ç–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
                        role: 'user',
                        avatar_color: '#FF0000',
                        tg_username: '@test'
                    };
                    updateUserDisplay();
                }
            }
        }

        function updateUserDisplay() {
            if (!currentUser) return;
            
            // –ê–≤–∞—Ç–∞—Ä
            const avatar = document.getElementById('currentUserAvatar');
            if (avatar) {
                avatar.style.backgroundColor = currentUser.avatar_color || '#FF0000';
                avatar.textContent = currentUser.nickname?.charAt(0).toUpperCase() || 'A';
            }
            
            // –ò–º—è
            const name = document.getElementById('currentUserName');
            if (name) {
                name.textContent = currentUser.nickname || '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
            }
            
            // –†–æ–ª—å
            const role = document.getElementById('currentUserRole');
            if (role) {
                let roleText = 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                if (currentUser.role === 'admin') roleText = 'üëë –ê–¥–º–∏–Ω';
                if (currentUser.role === 'super_admin') roleText = 'üëëüëëüëë –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω';
                role.textContent = roleText;
            }
            
            // –°—Ç–∞—Ç—É—Å —Ç–æ—á–∫–∏
            const statusDot = document.getElementById('statusDot');
            if (statusDot) {
                statusDot.className = 'status-dot online';
            }
        }

        function updateUserStatus() {
            if (socket && socket.connected && currentUser) {
                socket.emit('user_activity', {
                    userId: currentUser.id,
                    status: 'online'
                });
            }
        }

        // ========== WebSocket ==========
        function initSocket() {
            try {
                socket = io(window.location.origin, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionAttempts: MAX_RECONNECT_ATTEMPTS,
                    reconnectionDelay: 1000,
                    timeout: 10000
                });
                
                setupSocketListeners();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ WebSocket:', error);
                showNotification('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —á–∞—Ç—É', 'error');
            }
        }

        function setupSocketListeners() {
            // –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            socket.on('connect', () => {
                console.log('‚úÖ WebSocket –ø–æ–¥–∫–ª—é—á–µ–Ω! ID:', socket.id);
                reconnectAttempts = 0;
                updateConnectionStatus(true);
                
                // –ê–≤—Ç–æ—Ä–∏–∑—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                if (currentUser) {
                    socket.emit('auth', {
                        id: currentUser.id,
                        nickname: currentUser.nickname,
                        avatar_color: currentUser.avatar_color,
                        role: currentUser.role
                    });
                }
                
                // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é
                socket.emit('get_messages');
            });
            
            // –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π
            socket.on('messages_history', (data) => {
                console.log('üìú –ü–æ–ª—É—á–µ–Ω–∞ –∏—Å—Ç–æ—Ä–∏—è:', data.length, '—Å–æ–æ–±—â–µ–Ω–∏–π');
                messages = data;
                displayMessages(messages);
                updateMessageCount();
            });
            
            // –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
            socket.on('new_message', (message) => {
                console.log('üì® –ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:', message);
                
                // –î–æ–±–∞–≤–ª—è–µ–º –≤ –º–∞—Å—Å–∏–≤
                messages.push(message);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º
                displayMessage(message);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫
                updateMessageCount();
                
                // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ)
                if (document.getElementById('notifyNewMessages')?.checked) {
                    if (document.hidden) {
                        showBrowserNotification(message.user.nickname, message.text);
                    }
                    
                    // –ó–≤—É–∫ (–µ—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω)
                    if (document.getElementById('soundEffects')?.checked) {
                        playNotificationSound();
                    }
                }
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                scrollToBottom();
            });
            
            // –û–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            socket.on('online_users_update', (data) => {
                console.log('üë• –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', data.users.length);
                onlineUsers = data.users;
                displayOnlineUsers();
                updateOnlineCount();
            });
            
            // –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—á–∞—Ç–∞–µ—Ç
            socket.on('user_typing', (data) => {
                if (data.userId === currentUser.id) return;
                
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.textContent = `${data.nickname} –ø–µ—á–∞—Ç–∞–µ—Ç...`;
                    
                    clearTimeout(typingTimeout);
                    typingTimeout = setTimeout(() => {
                        indicator.textContent = '';
                    }, 3000);
                }
            });
            
            // –î–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞
            socket.on('admin_action', (data) => {
                console.log('üî® –î–µ–π—Å—Ç–≤–∏–µ –∞–¥–º–∏–Ω–∞:', data);
                
                if (data.userId === currentUser.id) {
                    switch (data.action) {
                        case 'ban':
                            showNotification('üö´ –í—ã –±—ã–ª–∏ –∑–∞–±–∞–Ω–µ–Ω—ã –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º!', 'error');
                            setTimeout(() => {
                                localStorage.removeItem('acaragraph_user');
                                window.location.href = 'index.html';
                            }, 3000);
                            break;
                            
                        case 'mute':
                            showNotification('üîá –í—ã –∑–∞–º—å—é—á–µ–Ω—ã –Ω–∞ 5 –º–∏–Ω—É—Ç', 'warning');
                            break;
                    }
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                loadOnlineUsers();
            });
            
            // –û—Ç–∫–ª—é—á–µ–Ω–∏–µ
            socket.on('disconnect', (reason) => {
                console.log('‚ùå WebSocket –æ—Ç–∫–ª—é—á–µ–Ω:', reason);
                updateConnectionStatus(false);
                
                if (reason === 'io server disconnect') {
                    // –°–µ—Ä–≤–µ—Ä –æ—Ç–∫–ª—é—á–∏–ª, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                    socket.connect();
                }
            });
            
            // –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
            socket.on('connect_error', (error) => {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è WebSocket:', error);
                reconnectAttempts++;
                
                if (reconnectAttempts >= MAX_RECONNECT_ATTEMPTS) {
                    showNotification('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É', 'error');
                } else {
                    showNotification(`–ü–æ–ø—ã—Ç–∫–∞ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ${reconnectAttempts}/${MAX_RECONNECT_ATTEMPTS}`, 'warning');
                }
            });
            
            // –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            socket.on('reconnect', (attemptNumber) => {
                console.log(`‚úÖ –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ (–ø–æ–ø—ã—Ç–∫–∞ ${attemptNumber})`);
                reconnectAttempts = 0;
                updateConnectionStatus(true);
                showNotification('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'success');
            });
        }

        function updateConnectionStatus(connected) {
            const dot = document.getElementById('connectionDot');
            const text = document.querySelector('#connectionStatus span');
            
            if (connected) {
                dot.style.background = '#00CC00';
                if (text) text.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω';
            } else {
                dot.style.background = '#FF3333';
                if (text) text.textContent = '–û—Ç–∫–ª—é—á–µ–Ω';
            }
        }

        function checkConnection() {
            if (!socket || !socket.connected) {
                console.log('üîÑ –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è: –æ—Ç–∫–ª—é—á–µ–Ω');
                updateConnectionStatus(false);
            }
        }

        // ========== –°–û–û–ë–©–ï–ù–ò–Ø ==========
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text || !currentUser) {
                return;
            }
            
            if (!socket || !socket.connected) {
                showNotification('‚ùå –ù–µ—Ç —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                return;
            }
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ WebSocket
            socket.emit('send_message', {
                userId: currentUser.id,
                text: text,
                type: 'text'
            });
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            input.value = '';
            input.style.height = 'auto';
            updateCharCount();
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –ø–µ—á–∞—Ç–∞–Ω–∏—è
            if (isTyping) {
                isTyping = false;
                socket.emit('typing_stop');
            }
        }

        function checkTyping() {
            const input = document.getElementById('messageInput');
            
            if (input.value.length > 0 && !isTyping) {
                isTyping = true;
                socket.emit('typing', {
                    userId: currentUser.id,
                    nickname: currentUser.nickname
                });
            } else if (input.value.length === 0 && isTyping) {
                isTyping = false;
                socket.emit('typing_stop');
            }
        }

        function handleKeyDown(event) {
            const enterToSend = document.getElementById('enterToSend')?.checked ?? true;
            
            if (event.key === 'Enter') {
                if (enterToSend && !event.shiftKey) {
                    event.preventDefault();
                    sendMessage();
                }
            }
        }

        function autoResize(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            updateCharCount();
        }

        function updateCharCount() {
            const input = document.getElementById('messageInput');
            const counter = document.getElementById('charCount');
            
            if (input && counter) {
                const length = input.value.length;
                counter.textContent = `${length}/2000`;
                
                if (length > 1900) {
                    counter.style.color = '#FF3333';
                } else if (length > 1500) {
                    counter.style.color = '#FF9900';
                } else {
                    counter.style.color = '#888888';
                }
            }
        }

        async function loadMessages() {
            try {
                const response = await fetch('/api/chat/messages?limit=100');
                const data = await response.json();
                
                if (data.success) {
                    messages = data.messages;
                    displayMessages(messages);
                    updateMessageCount();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π:', error);
            }
        }

        function displayMessages(messages) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (messages.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666666;">
                        <i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 20px;"></i>
                        <p>–ü–æ–∫–∞ –Ω–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π</p>
                        <p style="font-size: 14px; margin-top: 10px;">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ!</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(message => {
                displayMessage(message);
            });
            
            scrollToBottom();
        }

        function displayMessage(message) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –ª–∏ —É–∂–µ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (document.getElementById(`message-${message.id}`)) {
                return;
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.id = `message-${message.id}`;
            
            const time = formatTime(message.timestamp || message.created_at);
            const isCurrentUser = message.user?.id === currentUser?.id;
            
            messageDiv.innerHTML = `
                <div class="message-avatar" 
                     style="background-color: ${message.user?.avatar_color || '#FF0000'}"
                     onclick="showProfile(${message.user?.id})">
                    ${message.user?.nickname?.charAt(0).toUpperCase() || '?'}
                </div>
                <div class="message-content" style="${isCurrentUser ? 'background: rgba(255, 0, 0, 0.1);' : ''}">
                    <div class="message-header">
                        <strong class="message-sender" onclick="showProfile(${message.user?.id})">
                            ${message.user?.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π'}
                            ${message.user?.role === 'admin' ? 'üëë' : ''}
                            ${message.user?.role === 'super_admin' ? 'üëëüëëüëë' : ''}
                        </strong>
                        <span class="message-time">${time}</span>
                    </div>
                    <div class="message-text">${escapeHtml(message.text)}</div>
                    <div class="message-actions">
                        <button class="message-action-btn" onclick="replyToMessage(${message.id}, '${message.user?.nickname}')">
                            <i class="fas fa-reply"></i> –û—Ç–≤–µ—Ç–∏—Ç—å
                        </button>
                        ${currentUser?.role === 'admin' || currentUser?.role === 'super_admin' ? `
                            <button class="message-action-btn" onclick="deleteMessage(${message.id})">
                                <i class="fas fa-trash"></i> –£–¥–∞–ª–∏—Ç—å
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
            
            container.appendChild(messageDiv);
        }

        function updateMessageCount() {
            const count = messages.length;
            const counter = document.getElementById('messageCount');
            if (counter) {
                counter.textContent = count;
            }
        }

        function clearChat() {
            if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—á–∏—Å—Ç–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) {
                const container = document.getElementById('chatMessages');
                if (container) {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: #666666;">
                            <i class="fas fa-comment-slash" style="font-size: 48px; margin-bottom: 20px;"></i>
                            <p>–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—á–∏—â–µ–Ω–∞</p>
                        </div>
                    `;
                }
                messages = [];
                updateMessageCount();
                
                showNotification('–ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π –æ—á–∏—â–µ–Ω–∞', 'info');
            }
        }

        function replyToMessage(messageId, username) {
            const input = document.getElementById('messageInput');
            input.value = `@${username} `;
            input.focus();
        }

        function deleteMessage(messageId) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ?')) {
                // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
                const messageDiv = document.getElementById(`message-${messageId}`);
                if (messageDiv) {
                    messageDiv.style.opacity = '0.5';
                    messageDiv.style.textDecoration = 'line-through';
                }
                
                showNotification('–°–æ–æ–±—â–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
            }
        }

        // ========== –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ò ==========
        async function loadOnlineUsers() {
            try {
                const response = await fetch('/api/chat/online');
                const data = await response.json();
                
                if (data.success) {
                    onlineUsers = data.users;
                    displayOnlineUsers();
                    updateOnlineCount();
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–Ω–ª–∞–π–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
            }
        }

        function displayOnlineUsers() {
            const container = document.getElementById('usersList');
            if (!container) return;
            
            container.innerHTML = '';
            
            if (onlineUsers.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #666666;">
                        <i class="fas fa-user-slash" style="font-size: 24px; margin-bottom: 10px;"></i>
                        <p style="font-size: 14px;">–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –æ–Ω–ª–∞–π–Ω</p>
                    </div>
                `;
                return;
            }
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const otherUsers = onlineUsers.filter(user => user.id !== currentUser?.id);
            
            otherUsers.forEach(user => {
                const userDiv = document.createElement('div');
                userDiv.className = 'user-item';
                userDiv.onclick = () => showProfile(user.id);
                
                userDiv.innerHTML = `
                    <div class="user-avatar-sm" style="background-color: ${user.avatar_color || '#FF0000'}">
                        ${user.nickname?.charAt(0).toUpperCase() || '?'}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: bold; color: #FFFFFF;">${user.nickname}</div>
                        <div style="font-size: 12px; color: #FF6666;">
                            ${user.role === 'admin' ? 'üëë –ê–¥–º–∏–Ω' : ''}
                            ${user.role === 'super_admin' ? 'üëëüëëüëë –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω' : ''}
                        </div>
                    </div>
                    <div class="status-dot ${user.status || 'online'}"></div>
                `;
                
                container.appendChild(userDiv);
            });
        }

        function updateOnlineCount() {
            const count = onlineUsers.length;
            const counter = document.getElementById('onlineCount');
            const usersCounter = document.getElementById('onlineUsersCount');
            
            if (counter) counter.textContent = count;
            if (usersCounter) usersCounter.textContent = `${count} —á–µ–ª.`;
        }

        // ========== –ü–†–û–§–ò–õ–¨ ==========
        function showProfile(userId) {
            selectedUserId = userId;
            
            const user = onlineUsers.find(u => u.id === userId) || 
                        messages.find(m => m.user?.id === userId)?.user;
            
            if (!user) {
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å —Å–µ—Ä–≤–µ—Ä–∞
                fetch(`/api/user/${userId}`)
                    .then(res => res.json())
                    .then(data => {
                        if (data.success) {
                            displayProfile(data.user);
                        } else {
                            showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                        }
                    })
                    .catch(error => {
                        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è:', error);
                        showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è', 'error');
                    });
                return;
            }
            
            displayProfile(user);
        }

        function displayProfile(user) {
            const modal = document.getElementById('profileModal');
            const avatar = document.getElementById('profileUserAvatar');
            const name = document.getElementById('profileUserName');
            const nickname = document.getElementById('profileNickname');
            const telegram = document.getElementById('profileTelegram');
            const role = document.getElementById('profileUserRole');
            const status = document.getElementById('profileUserStatus');
            const adminActions = document.getElementById('adminActions');
            
            if (avatar) {
                avatar.style.backgroundColor = user.avatar_color || '#FF0000';
                avatar.textContent = user.nickname?.charAt(0).toUpperCase() || '?';
            }
            
            if (name) name.textContent = user.nickname || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π';
            if (nickname) nickname.textContent = user.nickname || '-';
            if (telegram) telegram.textContent = user.tg_username || '-';
            
            if (role) {
                let roleText = 'üë§ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å';
                if (user.role === 'admin') roleText = 'üëë –ê–¥–º–∏–Ω';
                if (user.role === 'super_admin') roleText = 'üëëüëëüëë –°—É–ø–µ—Ä-–∞–¥–º–∏–Ω';
                role.textContent = roleText;
                                role.className = user.role === 'admin' || user.role === 'super_admin' ? 'status-badge status-admin' : 'status-badge status-active';
            }
            
            if (status) {
                status.textContent = user.is_banned ? 'üö´ –ó–∞–±–∞–Ω–µ–Ω' : '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω';
                status.className = user.is_banned ? 'status-badge status-banned' : 'status-badge status-active';
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∞–¥–º–∏–Ω–∞ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —Ç–µ–∫—É—â–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–¥–º–∏–Ω –∏ —ç—Ç–æ –Ω–µ –æ–Ω —Å–∞–º
            if (adminActions && currentUser && 
                (currentUser.role === 'admin' || currentUser.role === 'super_admin') && 
                user.id !== currentUser.id) {
                adminActions.style.display = 'block';
            } else if (adminActions) {
                adminActions.style.display = 'none';
            }
            
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeProfile() {
            const modal = document.getElementById('profileModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
            selectedUserId = null;
        }

        function adminAction(action) {
            if (!selectedUserId || !currentUser) return;
            
            const actions = {
                'ban': { text: '–ó–∞–±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?', confirm: '–î–∞, –∑–∞–±–∞–Ω–∏—Ç—å' },
                'mute': { text: '–ó–∞–º—å—é—Ç–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ 5 –º–∏–Ω—É—Ç?', confirm: '–î–∞, –∑–∞–º—å—é—Ç–∏—Ç—å' },
                'make_admin': { text: '–°–¥–µ–ª–∞—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º?', confirm: '–î–∞, —Å–¥–µ–ª–∞—Ç—å –∞–¥–º–∏–Ω–æ–º' },
                'remove_admin': { text: '–£–±—Ä–∞—Ç—å –ø—Ä–∞–≤–∞ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞?', confirm: '–î–∞, —É–±—Ä–∞—Ç—å' }
            };
            
            if (!actions[action]) return;
            
            if (confirm(actions[action].text)) {
                fetch('/api/admin/users/action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        adminId: currentUser.id,
                        userId: selectedUserId,
                        action: action
                    })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification(data.message || '–î–µ–π—Å—Ç–≤–∏–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ', 'success');
                        closeProfile();
                        loadOnlineUsers();
                    } else {
                        showNotification(data.message || '–û—à–∏–±–∫–∞', 'error');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ –¥–µ–π—Å—Ç–≤–∏—è –∞–¥–º–∏–Ω–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è', 'error');
                });
            }
        }

        // ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
        function showSettings() {
            const modal = document.getElementById('settingsModal');
            const userId = document.getElementById('sessionUserId');
            const loginTime = document.getElementById('sessionLoginTime');
            
            if (userId && currentUser) {
                userId.textContent = currentUser.id;
            }
            
            if (loginTime) {
                loginTime.textContent = new Date().toLocaleTimeString();
            }
            
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        function loadSettings() {
            try {
                const settings = JSON.parse(localStorage.getItem('acaragraph_settings') || '{}');
                
                // –ü—Ä–∏–º–µ–Ω—è–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
                const notifyNewMessages = document.getElementById('notifyNewMessages');
                const notifyUserJoin = document.getElementById('notifyUserJoin');
                const enterToSend = document.getElementById('enterToSend');
                const soundEffects = document.getElementById('soundEffects');
                
                if (notifyNewMessages) notifyNewMessages.checked = settings.notifyNewMessages !== false;
                if (notifyUserJoin) notifyUserJoin.checked = settings.notifyUserJoin !== false;
                if (enterToSend) enterToSend.checked = settings.enterToSend !== false;
                if (soundEffects) soundEffects.checked = settings.soundEffects !== false;
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
            }
        }

        function saveSettings() {
            try {
                const settings = {
                    notifyNewMessages: document.getElementById('notifyNewMessages')?.checked ?? true,
                    notifyUserJoin: document.getElementById('notifyUserJoin')?.checked ?? true,
                    enterToSend: document.getElementById('enterToSend')?.checked ?? true,
                    soundEffects: document.getElementById('soundEffects')?.checked ?? true
                };
                
                localStorage.setItem('acaragraph_settings', JSON.stringify(settings));
                showNotification('–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã', 'success');
                closeSettings();
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –Ω–∞—Å—Ç—Ä–æ–µ–∫', 'error');
            }
        }

        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function formatTime(timestamp) {
            if (!timestamp) return '';
            
            const date = new Date(timestamp);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            // –ï—Å–ª–∏ —Å–µ–≥–æ–¥–Ω—è
            if (date.toDateString() === now.toDateString()) {
                if (diffMins < 1) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
                if (diffMins < 60) return `${diffMins} –º–∏–Ω –Ω–∞–∑–∞–¥`;
                return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            }
            
            // –ï—Å–ª–∏ –≤—á–µ—Ä–∞
            const yesterday = new Date(now);
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return `–≤—á–µ—Ä–∞ ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            // –ï—Å–ª–∏ –Ω–∞ —ç—Ç–æ–π –Ω–µ–¥–µ–ª–µ
            const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
            if (diffDays < 7) {
                const days = ['–í–°', '–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë'];
                return `${days[date.getDay()]} ${date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}`;
            }
            
            // –ë–æ–ª–µ–µ –Ω–µ–¥–µ–ª–∏ –Ω–∞–∑–∞–¥
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function scrollToBottom() {
            const container = document.getElementById('chatMessages');
            if (container) {
                setTimeout(() => {
                    container.scrollTop = container.scrollHeight;
                }, 100);
            }
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notificationContainer');
            if (!container) return;
            
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas ${icons[type] || icons.info}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: #AAAAAA; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            // –ê–≤—Ç–æ—É–¥–∞–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, 5000);
        }

        function showBrowserNotification(title, body) {
            if (!("Notification" in window)) return;
            
            if (Notification.permission === "granted") {
                new Notification(title, { body, icon: '/favicon.ico' });
            } else if (Notification.permission !== "denied") {
                Notification.requestPermission().then(permission => {
                    if (permission === "granted") {
                        new Notification(title, { body, icon: '/favicon.ico' });
                    }
                });
            }
        }

        function playNotificationSound() {
            try {
                // –°–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –∑–≤—É–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.value = 800;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.5);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.5);
                
            } catch (error) {
                console.log('‚ùå –û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∑–≤—É–∫–∞:', error);
            }
        }

        function insertEmoji(emoji) {
            const input = document.getElementById('messageInput');
            input.value += emoji;
            input.focus();
            autoResize(input);
        }

        function attachFile() {
            showNotification('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç –≤ —Å–ª–µ–¥—É—é—â–µ–π –≤–µ—Ä—Å–∏–∏!', 'info');
        }

        function testConnection() {
            const button = document.querySelector('[onclick="testConnection()"]');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            button.disabled = true;
            
            fetch('/api/ping')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showNotification('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –æ—Ç–ª–∏—á–Ω–æ!', 'success');
                        button.innerHTML = '<i class="fas fa-check"></i> OK';
                        button.style.background = 'linear-gradient(135deg, #00CC00, #00AA00)';
                    } else {
                        throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                    }
                })
                .catch(error => {
                    console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
                    showNotification('‚ùå –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                    button.innerHTML = '<i class="fas fa-times"></i> –û–®–ò–ë–ö–ê';
                    button.style.background = 'linear-gradient(135deg, #FF3333, #CC0000)';
                })
                .finally(() => {
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = '';
                        button.disabled = false;
                    }, 3000);
                });
        }

        function logout() {
            if (confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏?')) {
                if (socket && socket.connected) {
                    socket.disconnect();
                }
                
                localStorage.removeItem('acaragraph_user');
                showNotification('–í—ã—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω', 'info');
                
                setTimeout(() => {
                    window.location.href = 'index.html';
                }, 1000);
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        window.onclick = function(event) {
            const profileModal = document.getElementById('profileModal');
            const settingsModal = document.getElementById('settingsModal');
            
            if (event.target === profileModal) {
                closeProfile();
            }
            if (event.target === settingsModal) {
                closeSettings();
            }
        };

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                closeProfile();
                closeSettings();
            }
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–∏–¥–∏–º–æ—Å—Ç–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('visibilitychange', function() {
            if (!document.hidden && currentUser) {
                updateUserStatus();
            }
        });

        // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ —Ç–µ–∫—Å—Ç–∞
        window.addEventListener('beforeunload', function(e) {
            const input = document.getElementById('messageInput');
            if (input && input.value.trim().length > 0) {
                e.preventDefault();
                e.returnValue = '–£ –≤–∞—Å –µ—Å—Ç—å –Ω–µ–æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ. –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø–æ–∫–∏–Ω—É—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É?';
            }
            
            // –£–≤–µ–¥–æ–º–ª—è–µ–º —Å–µ—Ä–≤–µ—Ä –æ –≤—ã—Ö–æ–¥–µ
            if (socket && socket.connected && currentUser) {
                socket.emit('user_offline', { userId: currentUser.id });
            }
        });

        // ========== –î–ï–ë–ê–ì –§–£–ù–ö–¶–ò–ò ==========
        window.debugInfo = function() {
            console.log('=== ACARAGRAPH DEBUG INFO ===');
            console.log('Current User:', currentUser);
            console.log('Socket:', socket ? 'Connected: ' + socket.connected : 'Not initialized');
            console.log('Online Users:', onlineUsers.length);
            console.log('Messages:', messages.length);
            console.log('Reconnect Attempts:', reconnectAttempts);
            console.log('Local Storage:', localStorage.length);
            console.log('=============================');
        };

        window.debugClearChat = function() {
            localStorage.removeItem('acaragraph_chat_cache');
            messages = [];
            const container = document.getElementById('chatMessages');
            if (container) container.innerHTML = '';
            showNotification('–õ–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à —á–∞—Ç–∞ –æ—á–∏—â–µ–Ω', 'info');
        };

        window.debugTestMessage = function() {
            const testMessage = {
                id: Date.now(),
                text: '–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç —Å–∏—Å—Ç–µ–º—ã',
                user: {
                    id: 0,
                    nickname: '–°–∏—Å—Ç–µ–º–∞',
                    avatar_color: '#FF0000',
                    role: 'system'
                },
                timestamp: new Date().toISOString()
            };
            
            displayMessage(testMessage);
            showNotification('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–æ–±–∞–≤–ª–µ–Ω–æ', 'info');
        };
    </script>
</body>
</html>