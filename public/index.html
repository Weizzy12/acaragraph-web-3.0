<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acaragraph Red - –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚ö°</text></svg>">
    <style>
        /* –ê–Ω–∏–º–∞—Ü–∏—è –ª–æ–≥–æ—Ç–∏–ø–∞ */
        @keyframes logoGlow {
            0%, 100% { filter: drop-shadow(0 0 10px #FF0000); }
            50% { filter: drop-shadow(0 0 20px #FF3333); }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è –≤–≤–æ–¥–∞ –∫–æ–¥–∞ */
        @keyframes codeInputFocus {
            0% { transform: scale(1); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* –ê–Ω–∏–º–∞—Ü–∏—è —Å–º–µ–Ω—ã —à–∞–≥–æ–≤ */
        .step-transition {
            animation: slideUp 0.5s ease;
        }
        
        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="login-page">
    <!-- –ê–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ–Ω -->
    <div class="background-animation">
        <div class="particle" style="top: 10%; left: 20%; animation-delay: 0s;"></div>
        <div class="particle" style="top: 30%; left: 70%; animation-delay: 1s;"></div>
        <div class="particle" style="top: 60%; left: 40%; animation-delay: 2s;"></div>
        <div class="particle" style="top: 80%; left: 80%; animation-delay: 3s;"></div>
    </div>

    <!-- –®–∞–≥ 1: –í–≤–æ–¥ –∫–æ–¥–∞ -->
    <div class="login-box step-transition" id="step1">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-bolt" style="animation: logoGlow 2s infinite;"></i>
            </div>
            <h1 class="logo-text">ACARAGRAPH</h1>
            <p class="text-center" style="color: #FF6666; margin-top: 5px;">RED EDITION</p>
            <p style="color: #AAAAAA; margin-top: 10px; font-size: 14px;">
                –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–∞ –∫–æ–¥–∞—Ö –¥–æ—Å—Ç—É–ø–∞
            </p>
        </div>

        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-key" style="margin-right: 8px;"></i>–ö–û–î –î–û–°–¢–£–ü–ê
            </label>
            <div class="input-with-icon">
                <input type="text" 
                       id="inviteCode" 
                       class="form-input" 
                       placeholder="–í–í–ï–î–ò–¢–ï –ò–ù–í–ê–ô–¢-–ö–û–î"
                       value="ADMIN-777"
                       maxlength="20"
                       autocomplete="off"
                       autocapitalize="characters"
                       style="font-family: 'Courier New', monospace; letter-spacing: 2px; font-weight: bold;">
                <div class="input-icon">
                    <i class="fas fa-lock"></i>
                </div>
            </div>
            <small style="color: #888888; display: block; margin-top: 8px;">
                üîê –ö–æ–¥ –≤—ã–≥–ª—è–¥–∏—Ç –∫–∞–∫: XXX-XXXXXX (–Ω–∞–ø—Ä–∏–º–µ—Ä: USER-123, ADMIN-777)
            </small>
        </div>

        <div class="form-group">
            <button class="btn btn-primary w-100" onclick="checkCode()" id="checkCodeBtn">
                <i class="fas fa-unlock-alt"></i>
                –ü–†–û–í–ï–†–ò–¢–¨ –ö–û–î
            </button>
        </div>

        <div id="error1" class="error-message" style="display: none; margin-top: 20px;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText1"></span>
        </div>

        <div id="success1" class="success-message" style="display: none; margin-top: 20px;">
            <i class="fas fa-check-circle"></i>
            <span id="successText1"></span>
        </div>

        <div class="text-center mt-3" style="color: #666666; font-size: 12px;">
            <p>üéØ –¢–µ—Å—Ç–æ–≤—ã–µ –∫–æ–¥—ã:</p>
            <div style="background: rgba(255, 0, 0, 0.1); padding: 10px; border-radius: 8px; margin-top: 10px;">
                <p style="color: #FF3333; margin: 5px 0;">
                    <strong>ADMIN-777</strong> - –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
                </p>
                <p style="color: #FF6666; margin: 5px 0;">
                    <strong>USER-123</strong> - –û–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
                </p>
                <p style="color: #FF9999; margin: 5px 0;">
                    <strong>GUEST-999</strong> - –ì–æ—Å—Ç–µ–≤–æ–π –¥–æ—Å—Ç—É–ø
                </p>
            </div>
        </div>

        <div class="text-center mt-4" style="border-top: 1px solid rgba(255, 0, 0, 0.2); padding-top: 20px;">
            <button class="btn btn-secondary btn-sm" onclick="showInfo()" style="margin-right: 10px;">
                <i class="fas fa-info-circle"></i> –û –ø—Ä–æ–µ–∫—Ç–µ
            </button>
            <button class="btn btn-secondary btn-sm" onclick="testConnection()">
                <i class="fas fa-wifi"></i> –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å
            </button>
        </div>
    </div>

    <!-- –®–∞–≥ 2: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
    <div class="login-box" id="step2" style="display: none;">
        <div class="logo">
            <div class="logo-icon">
                <i class="fas fa-user-plus" style="color: #FF3333;"></i>
            </div>
            <h2 style="color: #FF6666;">–°–û–ó–î–ê–ù–ò–ï –ü–†–û–§–ò–õ–Ø</h2>
            <p style="color: #AAAAAA; margin-top: 5px;">
                –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç! –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
            </p>
        </div>

        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-user" style="margin-right: 8px;"></i>–í–ê–®–ï –ò–ú–Ø –í –ß–ê–¢–ï
            </label>
            <input type="text" 
                   id="nickname" 
                   class="form-input" 
                   placeholder="–ü—Ä–∏–¥—É–º–∞–π—Ç–µ –∏–º—è (–æ—Ç 2 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤)"
                   maxlength="20"
                   autocomplete="off">
            <small style="color: #888888; display: block; margin-top: 5px;">
                üë§ –≠—Ç–æ –∏–º—è –±—É–¥—É—Ç –≤–∏–¥–µ—Ç—å –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">
                <i class="fab fa-telegram" style="margin-right: 8px;"></i>TELEGRAM USERNAME
            </label>
            <div class="input-with-icon">
                <input type="text" 
                       id="tgUsername" 
                       class="form-input" 
                       placeholder="@username"
                       value="@"
                       autocomplete="off">
                <div class="input-icon">
                    <i class="fab fa-telegram-plane"></i>
                </div>
            </div>
            <small style="color: #888888; display: block; margin-top: 5px;">
                üì± –£–∫–∞–∂–∏—Ç–µ –≤–∞—à Telegram –¥–ª—è —Å–≤—è–∑–∏ (–Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è —Å @)
            </small>
        </div>

        <div class="form-group">
            <label class="form-label">
                <i class="fas fa-palette" style="margin-right: 8px;"></i>–¶–í–ï–¢ –ê–í–ê–¢–ê–†–ê
            </label>
            <div id="colorPicker" style="display: flex; gap: 10px; margin-top: 10px;">
                <!-- –¶–≤–µ—Ç–∞ –±—É–¥—É—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã —Å–∫—Ä–∏–ø—Ç–æ–º -->
            </div>
            <small style="color: #888888; display: block; margin-top: 10px;">
                üé® –í—ã–±–µ—Ä–∏—Ç–µ —Ü–≤–µ—Ç –¥–ª—è –≤–∞—à–µ–≥–æ –∞–≤–∞—Ç–∞—Ä–∞
            </small>
        </div>

        <div class="form-group">
            <button class="btn btn-primary w-100" onclick="register()" id="registerBtn">
                <i class="fas fa-rocket"></i>
                –í–û–ô–¢–ò –í ACARAGRAPH
            </button>
        </div>

        <div id="error2" class="error-message" style="display: none; margin-top: 20px;">
            <i class="fas fa-exclamation-triangle"></i>
            <span id="errorText2"></span>
        </div>

        <div class="text-center mt-3">
            <button class="btn btn-secondary btn-sm" onclick="goBack()">
                <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫–æ–¥—É
            </button>
        </div>
    </div>

    <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 style="color: #FF0000;">
                    <i class="fas fa-info-circle" style="margin-right: 10px;"></i>
                    –û Acaragraph
                </h3>
                <button class="modal-close" onclick="hideInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div style="text-align: center; margin-bottom: 20px;">
                    <div style="font-size: 48px; color: #FF0000; margin-bottom: 10px;">
                        ‚ö°
                    </div>
                    <h3 style="color: #FF3333;">ACARAGRAPH RED</h3>
                    <p style="color: #888888;">–í–µ—Ä—Å–∏—è 1.0.0</p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #FF6666; margin-bottom: 10px;">
                        <i class="fas fa-shield-alt" style="margin-right: 8px;"></i>
                        –ß—Ç–æ —ç—Ç–æ?
                    </h4>
                    <p style="color: #AAAAAA;">
                        –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä —Å –¥–æ—Å—Ç—É–ø–æ–º –ø–æ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞–º. 
                        –¢–æ–ª—å–∫–æ —Ç–µ, —É –∫–æ–≥–æ –µ—Å—Ç—å –∫–æ–¥, –º–æ–≥—É—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –∫ —á–∞—Ç—É.
                    </p>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <h4 style="color: #FF6666; margin-bottom: 10px;">
                        <i class="fas fa-key" style="margin-right: 8px;"></i>
                        –ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç?
                    </h4>
                    <p style="color: #AAAAAA;">
                        1. –ü–æ–ª—É—á–∏—Ç–µ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥ –æ—Ç –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞<br>
                        2. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –Ω–∞ —ç—Ç–æ–π —Å—Ç—Ä–∞–Ω–∏—Ü–µ<br>
                        3. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å<br>
                        4. –ù–∞—Å–ª–∞–∂–¥–∞–π—Ç–µ—Å—å –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –æ–±—â–µ–Ω–∏–µ–º
                    </p>
                </div>
                
                <div style="background: rgba(255, 0, 0, 0.1); padding: 15px; border-radius: 8px; margin-top: 20px;">
                    <h4 style="color: #FF3333; margin-bottom: 10px;">
                        <i class="fas fa-exclamation-triangle" style="margin-right: 8px;"></i>
                        –í–∞–∂–Ω–æ!
                    </h4>
                    <p style="color: #FF9999; font-size: 14px;">
                        ‚Ä¢ –ù–µ –ø–µ—Ä–µ–¥–∞–≤–∞–π—Ç–µ –∫–æ–¥—ã –ø–æ—Å—Ç–æ—Ä–æ–Ω–Ω–∏–º<br>
                        ‚Ä¢ –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã –º–æ–≥—É—Ç –±–∞–Ω–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π<br>
                        ‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è —Ö—Ä–∞–Ω—è—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ<br>
                        ‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å —É–º–æ–º üòâ
                    </p>
                </div>
            </div>
            <div class="modal-footer" style="text-align: center; margin-top: 20px;">
                <button class="btn btn-primary" onclick="hideInfo()">
                    <i class="fas fa-check"></i> –ü–æ–Ω—è—Ç–Ω–æ
                </button>
            </div>
        </div>
    </div>

    <!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
    <div id="notificationContainer"></div>

    <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä (–¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏) -->
    <div id="progressBar" class="progress-bar" style="display: none; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999;">
        <div id="progressFill" class="progress-fill" style="width: 0%;"></div>
    </div>

    <script>
        // ========== –ì–õ–û–ë–ê–õ–¨–ù–´–ï –ü–ï–†–ï–ú–ï–ù–ù–´–ï ==========
        let currentCodeId = null;
        let currentCodeType = 'user';
        let selectedColor = '#FF0000';

        // ========== –£–¢–ò–õ–ò–¢–´ ==========
        function showProgress(percent = 0) {
            const progressBar = document.getElementById('progressBar');
            const progressFill = document.getElementById('progressFill');
            
            progressBar.style.display = 'block';
            progressFill.style.width = percent + '%';
            
            if (percent >= 100) {
                setTimeout(() => {
                    progressBar.style.display = 'none';
                }, 500);
            }
        }

        function showNotification(message, type = 'info', duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const icons = {
                'success': 'fa-check-circle',
                'error': 'fa-exclamation-circle',
                'warning': 'fa-exclamation-triangle',
                'info': 'fa-info-circle'
            };
            
            notification.innerHTML = `
                <i class="fas ${icons[type] || icons.info}"></i>
                <span>${message}</span>
                <button onclick="this.parentElement.remove()" style="margin-left: auto; background: none; border: none; color: #AAAAAA; cursor: pointer;">
                    <i class="fas fa-times"></i>
                </button>
            `;
            
            container.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    setTimeout(() => {
                        if (notification.parentNode) {
                            notification.parentNode.removeChild(notification);
                        }
                    }, 300);
                }
            }, duration);
        }

        // ========== –®–ê–ì 1: –ü–†–û–í–ï–†–ö–ê –ö–û–î–ê ==========
        async function checkCode() {
            console.log('üîê –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–≤–∞–π—Ç-–∫–æ–¥–∞...');
            
            const codeInput = document.getElementById('inviteCode');
            const button = document.getElementById('checkCodeBtn');
            const code = codeInput.value.trim().toUpperCase();
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!code) {
                showError('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞', 'step1');
                codeInput.focus();
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
            const codeRegex = /^[A-Z0-9]{3}-[A-Z0-9]{3,}$/;
            if (!codeRegex.test(code)) {
                showError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –∫–æ–¥–∞. –ü—Ä–∏–º–µ—Ä: XXX-XXXXXX', 'step1');
                return;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–†–û–í–ï–†–ö–ê...';
            button.disabled = true;
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –≤–≤–æ–¥–∞
            codeInput.style.animation = 'codeInputFocus 0.5s ease';
            setTimeout(() => {
                codeInput.style.animation = '';
            }, 500);
            
            try {
                showProgress(30);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch('/api/auth/check-code', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({ code: code })
                });
                
                showProgress(60);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data);
                
                if (data.success) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–æ–¥–∞
                    currentCodeId = data.codeId;
                    currentCodeType = data.codeType || 'user';
                    
                    showProgress(90);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showSuccess('‚úÖ –ö–æ–¥ –ø—Ä–∏–Ω—è—Ç!', 'step1');
                    
                    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –∫–æ–¥–∞
                    let roleText = '–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è';
                    if (currentCodeType === 'admin') roleText = '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
                    if (currentCodeType === 'super_admin') roleText = '—Å—É–ø–µ—Ä-–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞';
                    if (currentCodeType === 'guest') roleText = '–≥–æ—Å—Ç—è';
                    
                    showNotification(`–ö–æ–¥ –¥–ª—è ${roleText} –ø—Ä–∏–Ω—è—Ç!`, 'success');
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É
                    setTimeout(() => {
                        document.getElementById('step1').classList.remove('step-transition');
                        document.getElementById('step1').style.display = 'none';
                        
                        document.getElementById('step2').classList.add('step-transition');
                        document.getElementById('step2').style.display = 'block';
                        
                        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –≤—ã–±–æ—Ä —Ü–≤–µ—Ç–∞
                        initColorPicker();
                        
                        // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∏–º–µ–Ω–∏
                        const nicknameInput = document.getElementById('nickname');
                        nicknameInput.focus();
                        
                        showProgress(100);
                    }, 1500);
                    
                } else {
                    showError(data.message || '–ù–µ–≤–µ—Ä–Ω—ã–π –∫–æ–¥', 'step1');
                    codeInput.select();
                    showProgress(100);
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ –∫–æ–¥–∞:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.', 'step1');
                showProgress(100);
                
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // ========== –®–ê–ì 2: –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ==========
        async function register() {
            console.log('üë§ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è...');
            
            const nickname = document.getElementById('nickname').value.trim();
            const tgUsername = document.getElementById('tgUsername').value.trim();
            const button = document.getElementById('registerBtn');
            
            // –í–∞–ª–∏–¥–∞—Ü–∏—è
            if (!nickname || nickname.length < 2 || nickname.length > 20) {
                showError('–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 20 —Å–∏–º–≤–æ–ª–æ–≤', 'step2');
                document.getElementById('nickname').focus();
                return;
            }
            
            if (!tgUsername || !tgUsername.startsWith('@') || tgUsername.length < 2) {
                showError('Telegram –¥–æ–ª–∂–µ–Ω –Ω–∞—á–∏–Ω–∞—Ç—å—Å—è —Å @', 'step2');
                document.getElementById('tgUsername').focus();
                return;
            }
            
            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º Telegram
            let formattedTg = tgUsername;
            if (!formattedTg.startsWith('@')) {
                formattedTg = '@' + formattedTg;
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            const originalText = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø...';
            button.disabled = true;
            
            try {
                showProgress(30);
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        nickname: nickname,
                        tgUsername: formattedTg,
                        codeId: currentCodeId
                    })
                });
                
                showProgress(60);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('–û—Ç–≤–µ—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', data);
                
                if (data.success) {
                    showProgress(90);
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    localStorage.setItem('acaragraph_user', JSON.stringify(data.user));
                    console.log('‚úÖ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–æ—Ö—Ä–∞–Ω—ë–Ω:', data.user);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                    showNotification('üéâ –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞! –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...', 'success');
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∞
                    button.innerHTML = '<i class="fas fa-check"></i> –£–°–ü–ï–®–ù–û!';
                    button.style.background = 'linear-gradient(135deg, #00CC00, #00AA00)';
                    
                    // –ü–µ—Ä–µ—Ö–æ–¥ –≤ —á–∞—Ç
                    setTimeout(() => {
                        showProgress(100);
                        window.location.href = 'chat.html';
                    }, 2000);
                    
                } else {
                    showError(data.message || '–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏', 'step2');
                    showProgress(100);
                }
                
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏:', error);
                showError('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'step2');
                showProgress(100);
                
            } finally {
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }

        // ========== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ==========
        function showError(message, step) {
            console.error('‚ùå –û—à–∏–±–∫–∞:', message);
            
            const errorDiv = document.getElementById(step === 'step2' ? 'error2' : 'error1');
            const errorText = document.getElementById(step === 'step2' ? 'errorText2' : 'errorText1');
            
            if (errorDiv && errorText) {
                errorText.textContent = message;
                errorDiv.style.display = 'block';
                
                // –°–∫—Ä—ã–≤–∞–µ–º —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            showNotification(message, 'error');
        }

        function showSuccess(message, step) {
            console.log('‚úÖ –£—Å–ø–µ—Ö:', message);
            
            const successDiv = document.getElementById(step === 'step2' ? 'success2' : 'success1');
            const successText = document.getElementById(step === 'step2' ? 'successText2' : 'successText1');
            
            if (successDiv && successText) {
                successText.textContent = message;
                successDiv.style.display = 'block';
            }
        }

        function goBack() {
            document.getElementById('step2').classList.remove('step-transition');
            document.getElementById('step2').style.display = 'none';
            
            document.getElementById('step1').classList.add('step-transition');
            document.getElementById('step1').style.display = 'block';
            
            // –§–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∫–æ–¥–∞
            const codeInput = document.getElementById('inviteCode');
            codeInput.focus();
            codeInput.select();
        }

        function initColorPicker() {
            const colorPicker = document.getElementById('colorPicker');
            if (!colorPicker) return;
            
            // –ö—Ä–∞—Å–Ω–∞—è –ø–∞–ª–∏—Ç—Ä–∞
            const colors = [
                '#FF0000', '#FF3333', '#FF6666', '#FF9999', '#FF4D4D',
                '#E60000', '#CC0000', '#B30000', '#990000', '#800000',
                '#FF1A1A', '#FF4D4D', '#FF8080', '#FFB3B3', '#FFE6E6'
            ];
            
            colorPicker.innerHTML = '';
            
            colors.forEach(color => {
                const colorDiv = document.createElement('div');
                colorDiv.className = 'color-option';
                colorDiv.style.cssText = `
                    width: 30px;
                    height: 30px;
                    border-radius: 50%;
                    background-color: ${color};
                    cursor: pointer;
                    border: 2px solid transparent;
                    transition: all 0.3s;
                `;
                
                if (color === '#FF0000') {
                    colorDiv.style.borderColor = '#FFFFFF';
                    colorDiv.style.transform = 'scale(1.2)';
                    selectedColor = color;
                }
                
                colorDiv.onclick = function() {
                    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —É –≤—Å–µ—Ö
                    document.querySelectorAll('.color-option').forEach(el => {
                        el.style.borderColor = 'transparent';
                        el.style.transform = 'scale(1)';
                    });
                    
                    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π
                    this.style.borderColor = '#FFFFFF';
                    this.style.transform = 'scale(1.2)';
                    selectedColor = color;
                    
                    // –ê–Ω–∏–º–∞—Ü–∏—è
                    this.style.animation = 'pulse-glow 0.5s';
                    setTimeout(() => {
                        this.style.animation = '';
                    }, 500);
                };
                
                colorPicker.appendChild(colorDiv);
            });
        }

        function showInfo() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'block';
                document.body.style.overflow = 'hidden';
            }
        }

        function hideInfo() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        async function testConnection() {
            const button = document.querySelector('[onclick="testConnection()"]');
            const originalText = button.innerHTML;
            
            button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> –ü–†–û–í–ï–†–ö–ê...';
            button.disabled = true;
            
            try {
                const response = await fetch('/api/ping');
                const data = await response.json();
                
                if (data.success) {
                    showNotification('‚úÖ –°–µ—Ä–≤–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!', 'success');
                    button.innerHTML = '<i class="fas fa-wifi"></i> –°–í–Ø–ó–¨: OK';
                    button.style.background = 'linear-gradient(135deg, #00CC00, #00AA00)';
                    
                    setTimeout(() => {
                        button.innerHTML = originalText;
                        button.style.background = '';
                        button.disabled = false;
                    }, 3000);
                } else {
                    throw new Error('–°–µ—Ä–≤–µ—Ä –Ω–µ –æ—Ç–≤–µ—á–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ');
                }
            } catch (error) {
                console.error('‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', error);
                showNotification('‚ùå –ù–µ—Ç —Å–≤—è–∑–∏ —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
                button.innerHTML = '<i class="fas fa-wifi-slash"></i> –ù–ï–¢ –°–í–Ø–ó–ò';
                button.style.background = 'linear-gradient(135deg, #FF3333, #CC0000)';
                
                setTimeout(() => {
                    button.innerHTML = originalText;
                    button.style.background = '';
                    button.disabled = false;
                }, 3000);
            }
        }

        // ========== –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ==========
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Acaragraph Red - —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Ö–æ–¥–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º API
            fetch('/api/ping')
                .then(response => response.json())
                .then(data => {
                    console.log('‚úÖ API —Å—Ç–∞—Ç—É—Å:', data);
                    
                    // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–∂–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω - —Ä–µ–¥–∏—Ä–µ–∫—Ç –≤ —á–∞—Ç
                    const savedUser = localStorage.getItem('acaragraph_user');
                    if (savedUser) {
                        console.log('‚úÖ –ù–∞–π–¥–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å, —Ä–µ–¥–∏—Ä–µ–∫—Ç...');
                        showNotification('–û–±–Ω–∞—Ä—É–∂–µ–Ω —Å–æ—Ö—Ä–∞–Ω—ë–Ω–Ω—ã–π –ø—Ä–æ—Ñ–∏–ª—å...', 'info');
                        setTimeout(() => {
                            window.location.href = 'chat.html';
                        }, 1000);
                    }
                })
                .catch(error => {
                    console.error('‚ùå API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω:', error);
                    showNotification('‚ö†Ô∏è –°–µ—Ä–≤–µ—Ä –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω', 'warning');
                });
            
            // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –∫–æ–¥–∞
            const codeInput = document.getElementById('inviteCode');
            if (codeInput) {
                codeInput.focus();
                codeInput.select();
                
                // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter
                codeInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        checkCode();
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç–∫–∞ Enter –≤ –ø–æ–ª—è—Ö —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
            document.getElementById('nickname')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    register();
                }
            });
            
            document.getElementById('tgUsername')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    register();
                }
            });
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –µ–≥–æ
            window.onclick = function(event) {
                const modal = document.getElementById('infoModal');
                if (event.target === modal) {
                    hideInfo();
                }
            };
            
            // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–∞ Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    hideInfo();
                }
            });
            
            // –°–æ–∑–¥–∞–µ–º –∞–Ω–∏–º–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã
            createParticles();
        });

        function createParticles() {
            const container = document.querySelector('.background-animation');
            if (!container) return;
            
            for (let i = 0; i < 8; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.cssText = `
                    position: absolute;
                    width: ${Math.random() * 100 + 50}px;
                    height: ${Math.random() * 100 + 50}px;
                    background: radial-gradient(circle, rgba(255, 0, 0, 0.1) 0%, transparent 70%);
                    border-radius: 50%;
                    animation: float ${Math.random() * 20 + 10}s infinite ease-in-out;
                    animation-delay: ${Math.random() * 5}s;
                    opacity: ${Math.random() * 0.3 + 0.1};
                    top: ${Math.random() * 100}%;
                    left: ${Math.random() * 100}%;
                `;
                
                // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ keyframes –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏
                const style = document.createElement('style');
                style.textContent = `
                    @keyframes float {
                        0%, 100% { transform: translate(0, 0) rotate(0deg); }
                        25% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px) rotate(90deg); }
                        50% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px) rotate(180deg); }
                        75% { transform: translate(${Math.random() * 100 - 50}px, ${Math.random() * 100 - 50}px) rotate(270deg); }
                    }
                `;
                document.head.appendChild(style);
                
                container.appendChild(particle);
            }
        }

        // ========== –î–ï–ë–ê–ì –§–£–ù–ö–¶–ò–ò ==========
        window.debugCheckCode = function() {
            console.log('üõ† –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ checkCode()');
            checkCode();
        };

        window.debugRegister = function() {
            console.log('üõ† –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –≤—ã–∑–æ–≤ register()');
            register();
        };

        window.debugClearStorage = function() {
            localStorage.removeItem('acaragraph_user');
            console.log('üßπ –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—á–∏—â–µ–Ω–æ');
            showNotification('–õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –æ—á–∏—â–µ–Ω–æ', 'info');
        };
    </script>
</body>
</html>